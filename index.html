<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>CPBL Data Master | 中職策略對決</title>
    <style>
        :root { --accent: #00f2ff; --panel: rgba(15, 23, 42, 0.9); --bg: #020617; }
        body { background: var(--bg); color: #fff; font-family: 'PingFang TC', sans-serif; display: flex; height: 100vh; margin: 0; overflow: hidden; }
        
        .sidebar { width: 340px; background: var(--panel); border-right: 1px solid var(--accent); padding: 20px; display: flex; flex-direction: column; z-index: 10; }
        .main-view { flex: 1; position: relative; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        
        /* 球員卡片強化 */
        .card { background: linear-gradient(145deg, #1e293b, #020617); border: 1px solid #334155; padding: 15px; border-radius: 12px; margin-bottom: 15px; border-left: 5px solid var(--accent); }
        .player-header { display: flex; justify-content: space-between; align-items: center; }
        .team-tag { font-size: 0.7rem; padding: 2px 6px; border-radius: 4px; background: #334155; }
        .stats-row { display: flex; gap: 15px; font-size: 0.8rem; margin-top: 8px; color: #94a3b8; }
        .avg-highlight { color: var(--accent); font-weight: bold; }

        canvas { border: 2px solid #1e293b; border-radius: 20px; background: radial-gradient(circle, #1e293b 0%, #050a15 100%); cursor: crosshair; }
        
        .console { flex: 1; background: #000; border-radius: 8px; padding: 12px; font-family: 'Courier New', monospace; font-size: 0.85rem; overflow-y: auto; color: #00ff00; border: 1px solid #1e293b; }
        .controls { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-top: 15px; }
        
        button { background: transparent; border: 1px solid var(--accent); color: var(--accent); padding: 10px; border-radius: 8px; cursor: pointer; transition: 0.2s; font-size: 0.85rem; }
        button:hover { background: var(--accent); color: #000; }
        
        .hr-text { position: absolute; font-size: 4rem; font-weight: 900; color: #fbbf24; text-shadow: 0 0 20px #f59e0b; display: none; animation: pop 1s ease-out; pointer-events: none; }
        @keyframes pop { 0% { transform: scale(0); opacity: 0; } 50% { transform: scale(1.2); opacity: 1; } 100% { transform: scale(1); opacity: 0; } }
    </style>
</head>
<body>

<div class="sidebar">
    <h2 style="color: var(--accent); margin-top: 0;">CPBL STRATEGY</h2>
    
    <div class="card">
        <div class="player-header">
            <span id="p-name" style="font-weight:bold">投手載入中</span>
            <span class="team-tag" id="p-team">-</span>
        </div>
        <div class="stats-row">
            ERA: <span id="p-era">0.00</span> | VELO: <span id="p-velo">150k</span>
        </div>
    </div>

    <div class="card">
        <div class="player-header">
            <span id="b-name" style="font-weight:bold">打者載入中</span>
            <span class="team-tag" id="b-team">-</span>
        </div>
        <div class="stats-row">
            AVG: <span id="b-avg" class="avg-highlight">.000</span> | HR: <span id="b-hr">0</span>
        </div>
    </div>

    <div style="font-size: 0.9rem; margin-bottom: 10px;">
        本局紀錄: 安打 <span id="game-hits">0</span> / 打數 <span id="game-ab">0</span> 
        (打率: <span id="live-avg" class="avg-highlight">.000</span>)
    </div>
    
    <div class="console" id="log">> 初始化數據...</div>
    
    <div class="controls">
        <button onclick="setPitch('Fastball')">4縫線速球</button>
        <button onclick="setPitch('Slider')">橫向滑球</button>
        <button onclick="setPitch('Fork')">指叉掉落</button>
        <button onclick="setPitch('Curve')">曲球速差</button>
    </div>
</div>

<div class="main-view">
    <div id="hr-text" class="hr-text">HOME RUN!</div>
    <div style="margin-bottom:10px; opacity:0.6">點擊九宮格投球</div>
    <canvas id="gameCanvas" width="450" height="450"></canvas>
</div>

<script>
    // 擴充球員名單與能力值 (根據 CPBL 生涯數據)
    const pitchers = [
        { name: "古林睿煬", team: "統一", era: 1.66, velo: 157, breaking: 82 },
        { name: "徐若熙", team: "味全", era: 2.12, velo: 154, breaking: 94 },
        { name: "黃子鵬", team: "樂天", era: 3.20, velo: 142, breaking: 88 },
        { name: "德保拉", team: "中信", era: 2.98, velo: 148, breaking: 85 },
        { name: "陳仕朋", team: "富邦", era: 3.50, velo: 144, breaking: 80 }
    ];
    const batters = [
        { name: "林安可", team: "統一", avg: .275, hr: 22, power: 94 },
        { name: "陳傑憲", team: "統一", avg: .330, hr: 5, power: 65 },
        { name: "江坤宇", team: "中信", avg: .295, hr: 3, power: 60 },
        { name: "張育成", team: "富邦", avg: .280, hr: 15, power: 92 },
        { name: "朱育賢", team: "樂天", avg: .285, hr: 18, power: 88 },
        { name: "吉力吉撈", team: "味全", avg: .270, hr: 23, power: 96 }
    ];

    let state = {
        p: pitchers[0], b: batters[0],
        hits: 0, ab: 0, outs: 0,
        pitchType: 'Fastball',
        active: false
    };

    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');

    function init() {
        updateStats();
        drawZone();
        addLog("歡迎來到 CPBL 數據對局。投手：古林睿煬，打者：林安可。");
    }

    function drawZone() {
        ctx.clearRect(0, 0, 450, 450);
        ctx.strokeStyle = "#334155";
        for(let i=1; i<3; i++){
            ctx.beginPath(); ctx.moveTo(75+i*100, 75); ctx.lineTo(75+i*100, 375); ctx.stroke();
            ctx.beginPath(); ctx.moveTo(75, 75+i*100); ctx.lineTo(375, 75+i*100); ctx.stroke();
        }
        ctx.strokeStyle = varColor('--accent');
        ctx.strokeRect(75, 75, 300, 300);
    }

    canvas.addEventListener('mousedown', (e) => {
        if(state.active) return;
        const rect = canvas.getBoundingClientRect();
        pitchBall(e.clientX - rect.left, e.clientY - rect.top);
    });

    function pitchBall(tx, ty) {
        state.active = true;
        let f = 0, sx = 225, sy = 225;
        const anim = () => {
            f++; let p = f/18;
            let dx = (state.pitchType === 'Slider') ? p*45 : 0;
            let dy = (state.pitchType === 'Fork') ? p*55 : 0;
            drawZone();
            let cx = sx + (tx-sx)*p + dx;
            let cy = sy + (ty-sy)*p + dy;
            ctx.beginPath(); ctx.arc(cx, cy, 6+p*14, 0, Math.PI*2);
            ctx.fillStyle = "#fff"; ctx.fill();
            if(f < 18) requestAnimationFrame(anim);
            else resolve(cx, cy);
        };
        anim();
    }

    function resolve(x, y) {
        state.active = false;
        state.ab++;
        let inZone = x > 75 && x < 375 && y > 75 && y < 375;
        
        // 核心打擊率算法：基礎機率 + 球員能力 + 邊角判定
        let hitProb = state.b.avg - (state.p.era / 20);
        if(!inZone) hitProb -= 0.15; // 壞球難打
        
        if(Math.random() < hitProb) {
            state.hits++;
            if(Math.random() < (state.b.power/200)) {
                showHR();
                addLog(`!!! ${state.b.name} 轟出全壘打 !!!`);
            } else {
                addLog(`${state.b.name} 擊出安打。`);
            }
        } else {
            state.outs++;
            addLog(inZone ? "三振！" : "打者選球，壞球一顆。");
        }
        
        if(state.outs >= 3) nextBatter();
        updateStats();
    }

    function nextBatter() {
        state.outs = 0;
        state.b = batters[Math.floor(Math.random()*batters.length)];
        state.p = pitchers[Math.floor(Math.random()*pitchers.length)];
        addLog(`--- 換人：${state.p.name} vs ${state.b.name} ---`);
    }

    function updateStats() {
        document.getElementById('p-name').innerText = state.p.name;
        document.getElementById('p-team').innerText = state.p.team;
        document.getElementById('p-era').innerText = state.p.era;
        document.getElementById('p-velo').innerText = state.p.velo + 'k';
        document.getElementById('b-name').innerText = state.b.name;
        document.getElementById('b-team').innerText = state.b.team;
        document.getElementById('b-avg').innerText = state.b.avg.toFixed(3);
        document.getElementById('game-hits').innerText = state.hits;
        document.getElementById('game-ab').innerText = state.ab;
        let lAvg = state.ab === 0 ? 0 : state.hits / state.ab;
        document.getElementById('live-avg').innerText = lAvg.toFixed(3);
    }

    function showHR() {
        const el = document.getElementById('hr-text');
        el.style.display = 'block';
        setTimeout(() => el.style.display = 'none', 1000);
    }

    function addLog(m) {
        const c = document.getElementById('log');
        c.innerHTML = `<div>> ${m}</div>` + c.innerHTML;
    }

    function setPitch(t) { state.pitchType = t; addLog(`投手準備投出：${t}`); }
    function varColor(n) { return getComputedStyle(document.documentElement).getPropertyValue(n).trim(); }

    init();
</script>
</body>
</html>
