<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>WBC 2023：台日大賽 (跑壘進階版)</title>
    <style>
        :root { --accent: #00f2ff; --bg: #020617; --panel: #1e293b; --strike: #facc15; --tw-blue: #0038a8; --jp-red: #bc002d; }
        body { background: var(--bg); color: #fff; font-family: 'Segoe UI', sans-serif; margin: 0; display: flex; flex-direction: column; align-items: center; overflow: hidden; }
        
        /* 先發設定 */
        #setup-screen { position: absolute; inset: 0; z-index: 1000; background: radial-gradient(circle, #001f3f, #000); padding: 20px; display: flex; flex-direction: column; align-items: center; }
        .setup-container { display: grid; grid-template-columns: 1fr 1fr; gap: 30px; width: 90%; max-width: 1000px; height: 60vh; margin-top: 20px; }
        .pool-box { background: rgba(255,255,255,0.05); border: 1px solid var(--tw-blue); border-radius: 12px; overflow-y: auto; padding: 15px; }
        .p-item { background: #0f172a; padding: 10px; margin: 5px 0; border-radius: 6px; cursor: pointer; display: flex; justify-content: space-between; font-size: 0.85rem; border: 1px solid transparent; }
        .p-item.selected { border-color: var(--strike); background: rgba(250, 204, 21, 0.15); }

        /* 遊戲介面 */
        #game-screen { display: none; width: 100%; height: 100vh; flex-direction: column; }
        .line-score { width: 100%; background: #000; border-bottom: 2px solid var(--accent); padding: 5px 0; }
        .score-table { margin: 0 auto; border-collapse: collapse; font-family: monospace; text-align: center; font-size: 0.9rem; }
        .score-table td, th { padding: 4px 10px; border: 1px solid #1e293b; }

        .main-layout { display: flex; flex: 1; width: 100%; }
        .order-panel { width: 220px; background: rgba(0,0,0,0.8); padding: 15px; font-size: 0.8rem; border-right: 1px solid #334155; }
        .order-item { padding: 4px; border-radius: 4px; margin-bottom: 2px; color: #666; }
        .order-item.active { background: var(--accent); color: #000; font-weight: bold; }

        .sidebar { width: 280px; background: rgba(15, 23, 42, 0.95); padding: 20px; display: flex; flex-direction: column; gap: 10px; border-left: 1px solid #334155; }
        .pitch-menu { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
        .btn { background: transparent; border: 1px solid var(--accent); color: var(--accent); padding: 8px; border-radius: 6px; cursor: pointer; font-size: 0.8rem; }
        .btn.active { background: var(--accent); color: #000; font-weight: bold; }

        .light { width: 12px; height: 12px; border-radius: 50%; background: #2d3748; display: inline-block; margin: 0 4px; }
        .s-on { background: var(--strike); box-shadow: 0 0 10px var(--strike); }
        .b-on { background: #4ade80; box-shadow: 0 0 10px #4ade80; }
        .o-on { background: #ef4444; box-shadow: 0 0 10px #ef4444; }

        .canvas-container { flex: 1; position: relative; display: flex; justify-content: center; align-items: center; background: radial-gradient(circle, #1e293b, #050a15); }
        canvas { border-radius: 10px; border: 1px solid #334155; }
        
        .feedback-overlay { position: absolute; top: 15%; display: flex; flex-direction: column; align-items: center; pointer-events: none; z-index: 500; width: 100%; }
        #timing-text { font-size: 2.2rem; font-weight: 900; color: #fff; text-shadow: 0 0 10px #000; display: none; }
        #result-text { font-size: 3rem; font-weight: 900; color: var(--strike); text-shadow: 0 0 20px #000; display: none; margin-top: 5px; }
        
        .overlay { position: absolute; font-size: 4rem; font-weight: 900; display: none; z-index: 600; text-shadow: 0 0 30px #000; }
        .log { height: 100px; background: #000; color: #4ade80; padding: 10px; font-size: 0.75rem; overflow-y: auto; border: 1px solid #334155; font-family: monospace; }
        #start-btn { margin-top: 20px; padding: 12px 40px; background: var(--tw-blue); color: white; border: none; border-radius: 30px; cursor: pointer; display: none; }
    </style>
</head>
<body>

<div id="setup-screen">
    <h1 style="color:var(--accent)">WBC 2023：台日巔峰對決</h1>
    <h3 id="setup-status">請挑選 中華隊先發打序 (9人) 與 1 名投手</h3>
    <div class="setup-container">
        <div class="pool-box"><div id="tw-pool"></div></div>
        <div class="pool-box"><div id="my-lineup-display"></div></div>
    </div>
    <button id="start-btn" onclick="beginGame()">踏入台中洲際球場</button>
</div>

<div id="game-screen">
    <div class="line-score">
        <table class="score-table">
            <tr><th>TEAM</th><th>1</th><th>2</th><th>3</th><th>4</th><th>5</th><th>6</th><th>7</th><th>8</th><th>9</th><th>R</th><th>H</th></tr>
            <tr id="row-tpe"><td style="color:var(--accent)">TPE</td><td id="p1">0</td><td id="p2">-</td><td id="p3">-</td><td id="p4">-</td><td id="p5">-</td><td id="p6">-</td><td id="p7">-</td><td id="p8">-</td><td id="p9">-</td><td id="pr">0</td><td id="ph">0</td></tr>
            <tr id="row-jpn"><td style="color:var(--jp-red)">JPN</td><td id="c1">0</td><td id="c2">-</td><td id="c3">-</td><td id="c4">-</td><td id="c5">-</td><td id="c6">-</td><td id="c7">-</td><td id="c8">-</td><td id="c9">-</td><td id="cr">0</td><td id="ch">0</td></tr>
        </table>
    </div>

    <div class="main-layout">
        <div class="order-panel" id="order-ui">
            <div id="order-title" style="color:var(--accent); font-weight:bold; margin-bottom:10px;">打序看板</div>
            <div id="order-list"></div>
        </div>

        <div class="canvas-container">
            <div id="msg-ov" class="overlay">攻守交換</div>
            <div class="feedback-overlay">
                <div id="timing-text">PERFECT</div>
                <div id="result-text">安打!</div>
            </div>
            <canvas id="fieldCanvas" width="550" height="450"></canvas>
        </div>

        <div class="sidebar">
            <div style="background:#000; padding:12px; border-radius:8px; border:1px solid #444;">
                B <div id="b1" class="light"></div><div id="b2" class="light"></div><div id="b3" class="light"></div><br>
                S <div id="s1" class="light"></div><div id="s2" class="light"></div><br>
                O <div id="o1" class="light"></div><div id="o2" class="light"></div>
                <div id="base-ui" style="margin-top:10px; color:var(--accent); letter-spacing:10px; font-size:1.3rem; text-align:center;">◇ ◇ ◇</div>
            </div>
            <div class="pitch-menu">
                <button class="btn active" id="btn-fast" onclick="setPitch('Fastball', this)">速球</button>
                <button class="btn" onclick="setPitch('Slider', this)">滑球</button>
                <button class="btn" onclick="setPitch('Fork', this)">指叉</button>
                <button class="btn" onclick="setPitch('Curve', this)">曲球</button>
            </div>
            <div id="matchup" style="background:var(--panel); padding:10px; border-radius:5px; border-left:4px solid var(--tw-blue); font-size:0.8rem;"></div>
            <div class="log" id="log">> 歷史對決開始...</div>
        </div>
    </div>
</div>

<script>
    const canvas = document.getElementById('fieldCanvas');
    const ctx = canvas.getContext('2d');

    const TW_PLAYERS = [
        { name: "張育成", type: "B", avg: .438, pwr: "S" }, { name: "林立", type: "B", avg: .333 },
        { name: "陳傑憲", type: "B", avg: .357 }, { name: "吉力吉撈", type: "B", avg: .310 },
        { name: "鄭宗哲", type: "B", avg: .333 }, { name: "江坤宇", type: "B", avg: .280 },
        { name: "吳念庭", type: "B", avg: .300 }, { name: "王威晨", type: "B", avg: .250 },
        { name: "陳晨威", type: "B", avg: .290 }, { name: "黃子鵬", type: "P", era: 3.15 },
        { name: "宋家豪", type: "P", era: 1.80 }, { name: "曾峻岳", type: "P", era: 2.50 }
    ];

    const JP_ORDER = [
        { name: "Nootbaar", avg: .300 }, { name: "近藤健介", avg: .340 }, { name: "大谷翔平", avg: .435 },
        { name: "村上宗隆", avg: .280 }, { name: "吉田正尚", avg: .409 }, { name: "岡本和真", avg: .300 },
        { name: "山田哲人", avg: .250 }, { name: "源田壯亮", avg: .220 }, { name: "中村悠平", avg: .200 }
    ];

    let myLineup = { B: [], P: null };
    let state = {
        inning: 1, isTop: true, // 1上日本打(玩家投)
        s: 0, b: 0, o: 0, pScore: 0, cScore: 0, pHits: 0, cHits: 0,
        twIdx: 0, jpIdx: 0, 
        isAnim: false, pitchType: 'Fastball', pitchFrame: 0,
        bases: [false, false, false] // 一壘, 二壘, 三壘
    };

    function initSetup() {
        const poolEl = document.getElementById('tw-pool');
        TW_PLAYERS.forEach((p, i) => {
            const div = document.createElement('div');
            div.className = 'p-item'; div.innerHTML = `<span>${p.name}</span> <span>${p.type=='P'?'投':'打'}</span>`;
            div.onclick = () => selectPlayer(p, div); poolEl.appendChild(div);
        });
    }

    function selectPlayer(p, el) {
        if (el.classList.contains('selected')) return;
        if (p.type === 'P') { if (myLineup.P) return; myLineup.P = p; }
        else { if (myLineup.B.length >= 9) return; myLineup.B.push(p); }
        el.classList.add('selected');
        document.getElementById('my-lineup-display').innerHTML += `<div class='p-item'>${p.name}</div>`;
        if (myLineup.B.length === 9 && myLineup.P) document.getElementById('start-btn').style.display = 'block';
    }

    function beginGame() {
        document.getElementById('setup-screen').style.display = 'none';
        document.getElementById('game-screen').style.display = 'flex';
        updateOrderUI(); updateUI(); render();
    }

    function updateOrderUI() {
        const list = document.getElementById('order-list');
        list.innerHTML = '';
        const curOrder = state.isTop ? JP_ORDER : myLineup.B;
        const curIdx = state.isTop ? state.jpIdx : state.twIdx;
        curOrder.forEach((p, i) => {
            const div = document.createElement('div');
            div.className = `order-item ${i === curIdx ? 'active' : ''}`;
            div.innerText = `${i+1}. ${p.name}`;
            list.appendChild(div);
        });
    }

    function render(f = 0) {
        ctx.clearRect(0,0,550,450);
        ctx.strokeStyle = "rgba(0, 242, 255, 0.2)";
        ctx.strokeRect(175, 100, 200, 200);
        for(let i=1; i<3; i++) {
            ctx.beginPath(); ctx.moveTo(175+i*66.6, 100); ctx.lineTo(175+i*66.6, 300);
            ctx.moveTo(175, 100+i*66.6); ctx.lineTo(375, 100+i*66.6); ctx.stroke();
        }
        let legY = (f > 0 && f < 12) ? -35 : 0;
        ctx.strokeStyle = "#fff"; ctx.lineWidth = 4;
        ctx.beginPath(); ctx.arc(275, 360, 12, 0, Math.PI*2); ctx.stroke();
        ctx.moveTo(275, 372); ctx.lineTo(275, 410);
        ctx.moveTo(275, 410); ctx.lineTo(260, 445);
        ctx.moveTo(275, 410); ctx.lineTo(290, 445+legY); ctx.stroke();
    }

    canvas.addEventListener('mousedown', (e) => {
        if (state.isAnim) return;
        const rect = canvas.getBoundingClientRect();
        const tx = e.clientX - rect.left, ty = e.clientY - rect.top;
        if (state.isTop) startPitch(tx, ty); else swing(tx, ty);
    });

    function setPitch(t, b) { state.pitchType = t; document.querySelectorAll('.btn').forEach(x=>x.classList.remove('active')); b.classList.add('active'); }

    function startPitch(tx, ty) {
        state.isAnim = true; let f = 0;
        const anim = () => {
            f++; render(f);
            if(f < 18) requestAnimationFrame(anim);
            else {
                let bf = 0;
                const fly = () => {
                    bf++; state.pitchFrame = bf;
                    let p = bf/15; render(18);
                    let dx = state.pitchType==='Slider' ? p*60 : (state.pitchType==='Curve' ? p*-30 : 0);
                    let dy = state.pitchType==='Fork' ? p*70 : 0;
                    let cx = 275 + (tx-275)*p + dx;
                    let cy = 370 + (ty-370)*p + dy;
                    ctx.beginPath(); ctx.arc(cx, cy, 5+p*12, 0, Math.PI*2); ctx.fillStyle = "#fff"; ctx.fill();
                    if(bf < 15) requestAnimationFrame(fly); else resolve(cx, cy);
                }; fly();
            }
        }; anim();
    }

    function resolve(cx, cy) {
        state.isAnim = false;
        let inZone = cx > 175 && cx < 375 && cy > 100 && cy < 300;
        let batter = state.isTop ? JP_ORDER[state.jpIdx] : myLineup.B[state.twIdx];

        if (state.isTop) { // 日本隊攻擊
            if (inZone && Math.random() < batter.avg) {
                let quality = Math.random() > 0.8 ? 2 : 1; // 日本隊隨機二壘安打
                handleHit(quality);
            } else if (inZone) {
                state.s++; if (state.s >= 3) { state.o++; state.s=0; state.b=0; showFeedback("", "三振!"); nextBatter(); }
            } else {
                state.b++; if (state.b >= 4) { addLog("保送."); handleWalk(); }
            }
        } else { // 玩家打擊判定(未揮棒)
            if (inZone) { state.s++; addLog("好球!"); } else { state.b++; addLog("壞球."); }
            if (state.s >= 3) { state.o++; state.s=0; state.b=0; showFeedback("", "三振!"); nextBatter(); }
            if (state.b >= 4) { addLog("保送."); handleWalk(); }
        }
        checkInning(); updateUI();
    }

    function swing(tx, ty) {
        let timing = "TOO LATE";
        if (state.pitchFrame >= 12 && state.pitchFrame <= 14) timing = "PERFECT";
        else if (state.pitchFrame >= 10 && state.pitchFrame <= 15) timing = "GOOD";
        else if (state.pitchFrame < 10) timing = "TOO EARLY";

        let batter = myLineup.B[state.twIdx];
        if (timing === "PERFECT") {
            handleHit(2); showFeedback("PERFECT", "二壘安打!");
        } else if (timing === "GOOD" && Math.random() < batter.avg) {
            handleHit(1); showFeedback("GOOD", "一壘安打!");
        } else {
            state.s++; showFeedback(timing, "揮棒落空");
            if (state.s >= 3) { state.o++; state.s=0; state.b=0; showFeedback("", "三振!"); nextBatter(); }
        }
        checkInning(); updateUI();
    }

    // 核心跑壘邏輯
    function handleHit(bases) {
        let runs = 0;
        for (let i = 2; i >= 0; i--) {
            if (state.bases[i]) {
                if (i + bases >= 3) { runs++; state.bases[i] = false; }
                else { state.bases[i + bases] = true; state.bases[i] = false; }
            }
        }
        state.bases[bases - 1] = true; // 打者上壘
        if (state.isTop) { state.cScore += runs; state.cHits++; } else { state.pScore += runs; state.pHits++; }
        state.s = 0; state.b = 0; nextBatter();
    }

    function handleWalk() {
        let runs = 0;
        if (state.bases[0] && state.bases[1] && state.bases[2]) runs = 1; // 滿壘擠回一分
        else if (state.bases[0] && state.bases[1]) state.bases[2] = true;
        else if (state.bases[0]) state.bases[1] = true;
        state.bases[0] = true;
        if (state.isTop) state.cScore += runs; else state.pScore += runs;
        state.s = 0; state.b = 0; nextBatter();
    }

    function nextBatter() {
        if (state.isTop) state.jpIdx = (state.jpIdx + 1) % 9;
        else state.twIdx = (state.twIdx + 1) % 9;
        updateOrderUI();
    }

    function checkInning() {
        if (state.o >= 3) {
            state.o = 0; state.s = 0; state.b = 0; state.bases = [false, false, false];
            state.isTop = !state.isTop; if (state.isTop) state.inning++;
            const ov = document.getElementById('msg-ov');
            ov.style.display = 'block'; setTimeout(()=>ov.style.display='none', 1500);
            updateOrderUI();
        }
        if (!state.isTop && !state.isAnim) setTimeout(()=> { if(!state.isTop) cpuPitch(); }, 2000);
    }

    function cpuPitch() {
        const types = ['Fastball', 'Slider', 'Fork', 'Curve'];
        state.pitchType = types[Math.floor(Math.random()*4)];
        startPitch(200+Math.random()*150, 120+Math.random()*150);
    }

    function showFeedback(timing, result) {
        const t = document.getElementById('timing-text'), r = document.getElementById('result-text');
        t.innerText = timing; r.innerText = result;
        t.style.display = timing ? 'block' : 'none'; r.style.display = 'block';
        setTimeout(() => { t.style.display = 'none'; r.style.display = 'none'; }, 1200);
    }

    function updateUI() {
        document.getElementById('pr').innerText = state.pScore; document.getElementById('cr').innerText = state.cScore;
        document.getElementById('ph').innerText = state.pHits; document.getElementById('ch').innerText = state.cHits;
        const curScoreId = state.isTop ? `c${state.inning}` : `p${state.inning}`;
        document.getElementById(curScoreId).innerText = state.isTop ? state.cScore : state.pScore;
        
        document.getElementById('s1').className = state.s >= 1 ? 'light s-on' : 'light';
        document.getElementById('s2').className = state.s >= 2 ? 'light s-on' : 'light';
        document.getElementById('b1').className = state.b >= 1 ? 'light b-on' : 'light';
        document.getElementById('b2').className = state.b >= 2 ? 'light b-on' : 'light';
        document.getElementById('b3').className = state.b >= 3 ? 'light b-on' : 'light';
        document.getElementById('o1').className = state.o >= 1 ? 'light o-on' : 'light';
        document.getElementById('o2').className = state.o >= 2 ? 'light o-on' : 'light';
        
        const baseUI = state.bases.map(b => b ? "◆" : "◇").join(" ");
        document.getElementById('base-ui').innerText = baseUI;
        const p = state.isTop ? myLineup.P : {name: "山本由伸"};
        const b = state.isTop ? JP_ORDER[state.jpIdx] : myLineup.B[state.twIdx];
        document.getElementById('matchup').innerText = `${p.name} vs ${b.name}`;
    }

    function addLog(m) { const l = document.getElementById('log'); l.innerHTML = `<div>> ${m}</div>` + l.innerHTML; }

    initSetup();
</script>
</body>
</html>
