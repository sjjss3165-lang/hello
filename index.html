<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>CPBL Manager | 中職總教練模式</title>
    <style>
        :root { --accent: #00f2ff; --bg: #020617; --panel: #1e293b; }
        body { background: var(--bg); color: #fff; font-family: 'PingFang TC', sans-serif; margin: 0; display: flex; flex-direction: column; align-items: center; min-height: 100vh; }
        
        /* 賽前設定介面 */
        #setup-screen { width: 90%; max-width: 1000px; padding: 20px; display: block; }
        .setup-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .pool-section, .lineup-section { background: var(--panel); padding: 20px; border-radius: 12px; border: 1px solid #334155; }
        .player-item { background: #0f172a; padding: 8px; margin: 5px 0; border-radius: 4px; display: flex; justify-content: space-between; cursor: pointer; border: 1px solid transparent; }
        .player-item:hover { border-color: var(--accent); }
        .player-item.selected { background: var(--accent); color: #000; }
        
        /* 遊戲介面 (隱藏) */
        #game-screen { display: none; width: 100%; flex-direction: column; align-items: center; }
        
        .scoreboard { background: #1e293b; width: 90%; max-width: 800px; margin: 10px; border-radius: 8px; text-align: center; }
        .game-area { display: flex; gap: 20px; width: 95%; max-width: 1000px; height: 500px; }
        canvas { border: 2px solid var(--accent); border-radius: 20px; background: #000; cursor: crosshair; }
        
        .btn-main { background: var(--accent); color: #000; padding: 15px 40px; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; font-size: 1.2rem; margin-top: 20px; }
        .list-title { border-bottom: 2px solid var(--accent); margin-bottom: 10px; padding-bottom: 5px; font-weight: bold; }
    </style>
</head>
<body>

<div id="setup-screen">
    <h1 style="color: var(--accent); text-align: center;">CPBL 戰術室：球員名單設定</h1>
    <div class="setup-grid">
        <div class="pool-section">
            <div class="list-title">選手大名單 (點選加入先發)</div>
            <div id="player-pool"></div>
        </div>
        <div class="lineup-section">
            <div class="list-title">我的先發打序 (1-9 棒)</div>
            <div id="my-lineup"></div>
            <div class="list-title" style="margin-top:20px;">投手上場順序 (SP/RP/CP)</div>
            <div id="my-pitchers"></div>
            <button class="btn-main" onclick="startGame()" style="width:100%">確認名單，進入球場</button>
        </div>
    </div>
</div>

<div id="game-screen">
    <div class="scoreboard">
        <h2 id="match-title">實況對決</h2>
        <div id="bso" style="font-size: 1.5rem; letter-spacing: 10px; margin-bottom: 10px;">B ○○○ S ○○ O ○○</div>
    </div>
    <div class="game-area">
        <div style="width: 200px;">
            <div id="current-hitter-card" style="background:var(--panel); padding:15px; border-radius:8px;">
                <div style="font-size:0.8rem; opacity:0.6">當前打者</div>
                <div id="hitter-name" style="font-size:1.4rem; font-weight:bold;">-</div>
                <div id="hitter-stats">AVG: -</div>
            </div>
            <div id="log" style="margin-top:10px; height:250px; overflow-y:auto; font-size:0.8rem; color:#00ff00; background:#000; padding:10px;"></div>
        </div>
        <canvas id="gameCanvas" width="500" height="500"></canvas>
    </div>
</div>

<script>
    // 擴充球員池
    const ALL_PLAYERS = [
        { name: "陳傑憲", team: "獅", avg: .332, power: 65, type: 'B' },
        { name: "林安可", team: "獅", avg: .275, power: 95, type: 'B' },
        { name: "王柏融", team: "台鋼", avg: .300, power: 85, type: 'B' },
        { name: "張育成", team: "富邦", avg: .285, power: 98, type: 'B' },
        { name: "江坤宇", team: "象", avg: .298, power: 55, type: 'B' },
        { name: "陳晨威", team: "猿", avg: .310, power: 70, type: 'B' },
        { name: "朱育賢", team: "猿", avg: .282, power: 90, type: 'B' },
        { name: "吉力吉撈", team: "龍", avg: .270, power: 96, type: 'B' },
        { name: "詹子賢", team: "象", avg: .288, power: 80, type: 'B' },
        { name: "古林睿煬", team: "獅", era: 1.66, velo: 157, type: 'P' },
        { name: "徐若熙", team: "龍", era: 2.10, velo: 154, type: 'P' },
        { name: "黃子鵬", team: "猿", era: 3.15, velo: 145, type: 'P' },
        { name: "陳凱倫", team: "傳奇", avg: .260, power: 60, type: 'B' }
    ];

    let myLineup = [];
    let myPitchers = [];
    let currentGame = { hitterIdx: 0, pitcherIdx: 0, outs: 0, ballActive: false };

    // 初始化名單挑選
    function initSetup() {
        const pool = document.getElementById('player-pool');
        ALL_PLAYERS.forEach(p => {
            const div = document.createElement('div');
            div.className = 'player-item';
            div.innerHTML = `<span>${p.name} (${p.team})</span> <span>${p.type === 'P' ? 'ERA:'+p.era : 'AVG:'+p.avg}</span>`;
            div.onclick = () => selectPlayer(p, div);
            pool.appendChild(div);
        });
    }

    function selectPlayer(p, el) {
        if(p.type === 'B' && myLineup.length < 9) {
            myLineup.push(p);
            document.getElementById('my-lineup').innerHTML += `<div class="player-item">${myLineup.length}. ${p.name}</div>`;
            el.style.opacity = '0.3';
            el.onclick = null;
        } else if(p.type === 'P' && myPitchers.length < 3) {
            myPitchers.push(p);
            const roles = ['先發(SP)', '中繼(RP)', '救援(CP)'];
            document.getElementById('my-pitchers').innerHTML += `<div class="player-item">${roles[myPitchers.length-1]}: ${p.name}</div>`;
            el.style.opacity = '0.3';
            el.onclick = null;
        }
    }

    function startGame() {
        if(myLineup.length < 9 || myPitchers.length < 1) return alert("請選滿 9 位打者與至少 1 位投手！");
        document.getElementById('setup-screen').style.display = 'none';
        document.getElementById('game-screen').style.display = 'flex';
        nextAtBat();
    }

    // 遊戲核心邏輯 (延續 6.0 並加入名單)
    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');

    function nextAtBat() {
        const hitter = myLineup[currentGame.hitterIdx];
        document.getElementById('hitter-name').innerText = hitter.name;
        document.getElementById('hitter-stats').innerText = `AVG: .${hitter.avg*1000} | 戰力: ${hitter.power}`;
        addLog(`現在輪到第 ${currentGame.hitterIdx+1} 棒：${hitter.name}`);
        setTimeout(aiPitch, 1500);
    }

    function aiPitch() {
        currentGame.ballActive = true;
        let f = 0, sx = 250, sy = 250;
        const tx = 100 + Math.random()*300, ty = 100 + Math.random()*300;
        
        const anim = () => {
            f++; let p = f/25;
            ctx.clearRect(0,0,500,500);
            drawZone();
            let cx = sx + (tx-sx)*p;
            let cy = sy + (ty-sy)*p;
            ctx.beginPath(); ctx.arc(cx, cy, 5+p*15, 0, Math.PI*2);
            ctx.fillStyle = "#fff"; ctx.fill();
            currentGame.lastBall = {x:cx, y:cy, r:5+p*15};
            if(f < 25 && currentGame.ballActive) requestAnimationFrame(anim);
            else if(currentGame.ballActive) resolve(false);
        };
        anim();
    }

    canvas.addEventListener('mousedown', (e) => {
        if(!currentGame.ballActive) return;
        const rect = canvas.getBoundingClientRect();
        const dist = Math.sqrt((e.clientX-rect.left-currentGame.lastBall.x)**2 + (e.clientY-rect.top-currentGame.lastBall.y)**2);
        if(dist < currentGame.lastBall.r + 15) resolve(true, dist);
    });

    function resolve(isHit, dist) {
        currentGame.ballActive = false;
        if(isHit) {
            if(dist < 10) { addLog("全壘打！"); } else { addLog("擊出安打！"); }
        } else {
            addLog("揮棒落空！");
            currentGame.outs++;
        }
        
        if(currentGame.outs >= 3) {
            currentGame.outs = 0;
            addLog("三出局，換局。");
        }
        currentGame.hitterIdx = (currentGame.hitterIdx + 1) % 9;
        setTimeout(nextAtBat, 2000);
    }

    function drawZone() {
        ctx.strokeStyle = "#334155";
        ctx.strokeRect(100, 100, 300, 300);
    }

    function addLog(m) {
        const l = document.getElementById('log');
        l.innerHTML = `<div>> ${m}</div>` + l.innerHTML;
    }

    initSetup();
</script>
</body>
</html>
