<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>CPBL 鑽石對決 Pro</title>
    <style>
        :root { --grass: #15803d; --dirt: #92400e; --accent: #00f2ff; --bg: #020617; }
        body { background: var(--bg); color: #fff; font-family: 'PingFang TC', sans-serif; margin: 0; display: flex; flex-direction: column; align-items: center; overflow: hidden; }
        
        /* 頂部計分板 */
        .header { width: 100%; background: #1e293b; padding: 10px; border-bottom: 3px solid var(--accent); display: flex; justify-content: space-around; align-items: center; }
        .scoreboard { background: #000; padding: 10px; border-radius: 8px; font-family: 'Courier New', monospace; min-width: 250px; text-align: center; border: 2px solid #334155; }
        .bso { font-size: 1.2rem; letter-spacing: 5px; }
        .on { color: #facc15; text-shadow: 0 0 5px #facc15; }
        .out-on { color: #ef4444; text-shadow: 0 0 5px #ef4444; }

        /* 遊戲場景 */
        .game-view { position: relative; margin-top: 20px; }
        canvas { border-radius: 15px; border: 4px solid #334155; background: #15803d; cursor: crosshair; }
        
        .overlay-msg { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 4rem; font-weight: 900; color: #fbbf24; text-shadow: 0 0 20px #000; display: none; pointer-events: none; z-index: 100; }
        .log { width: 800px; height: 80px; background: rgba(0,0,0,0.8); margin-top: 10px; padding: 10px; font-size: 0.9rem; color: #4ade80; overflow-y: auto; border-radius: 8px; border: 1px solid #334155; }
    </style>
</head>
<body>

<div class="header">
    <div class="scoreboard">
        <div id="inning-display">1 局上 (防守)</div>
        <div style="font-size: 1.5rem;">我: <span id="my-score">0</span> | 電腦: <span id="ai-score">0</span></div>
    </div>
    <div class="bso">
        S <span id="s1">○</span><span id="s2">○</span> 
        B <span id="b1">○</span><span id="b2">○</span><span id="b3">○</span> 
        O <span id="o1">○</span><span id="o2">○</span>
    </div>
    <div id="base-map" style="font-size: 1.5rem; color: #94a3b8;">◇ ◇ ◇</div>
</div>

<div class="game-view">
    <div id="msg" class="overlay-msg">攻守交換</div>
    <canvas id="field" width="800" height="500"></canvas>
</div>

<div class="log" id="log">> 比賽開始！你先防守，請點擊九宮格投球。</div>

<script>
    const canvas = document.getElementById('field');
    const ctx = canvas.getContext('2d');
    
    let game = {
        inning: 1, isTop: true, // true: 1上(防守), false: 1下(進攻)
        scoreMy: 0, scoreAi: 0,
        strikes: 0, balls: 0, outs: 0,
        bases: [false, false, false],
        isAnimating: false,
        ball: { x: 400, y: 450, active: false }
    };

    function drawField() {
        ctx.clearRect(0, 0, 800, 500);
        // 畫草地與紅土
        ctx.fillStyle = '#15803d'; ctx.fillRect(0,0,800,500);
        ctx.fillStyle = '#92400e'; 
        ctx.beginPath(); ctx.moveTo(400, 480); ctx.arc(400, 480, 400, -Math.PI, 0); ctx.fill(); // 外野弧線
        
        // 畫內野鑽石
        ctx.fillStyle = '#16a34a';
        ctx.beginPath(); ctx.moveTo(400, 480); ctx.lineTo(520, 360); ctx.lineTo(400, 240); ctx.lineTo(280, 360); ctx.closePath(); ctx.fill();
        
        // 畫壘包
        ctx.fillStyle = '#fff';
        const b = 10;
        ctx.fillRect(400-b/2, 480-b/2, b, b); // 本壘
        ctx.fillRect(520-b/2, 360-b/2, b, b); // 一壘
        ctx.fillRect(400-b/2, 240-b/2, b, b); // 二壘
        ctx.fillRect(280-b/2, 360-b/2, b, b); // 三壘

        // 畫投打姿勢 (骨架)
        drawPlayers();
    }

    function drawPlayers() {
        ctx.strokeStyle = "#fff"; ctx.lineWidth = 3;
        // 投手
        ctx.beginPath(); ctx.arc(400, 320, 8, 0, Math.PI*2); ctx.stroke();
        ctx.moveTo(400, 328); ctx.lineTo(400, 350); ctx.stroke();
        // 打者
        ctx.beginPath(); ctx.arc(370, 470, 8, 0, Math.PI*2); ctx.stroke();
        ctx.moveTo(370, 478); ctx.lineTo(370, 495); ctx.stroke();
    }

    canvas.addEventListener('mousedown', (e) => {
        if (game.isAnimating) return;
        const rect = canvas.getBoundingClientRect();
        const tx = e.clientX - rect.left;
        const ty = e.clientY - rect.top;

        if (game.isTop) { // 防守：你投球
            game.isAnimating = true;
            animatePitch(tx, ty, resolveDefense);
        } else { // 進攻：你打擊
            if (game.ball.active) {
                const dist = Math.sqrt((tx - game.ball.x)**2 + (ty - game.ball.y)**2);
                if (dist < 30) resolveOffense(true, dist);
            }
        }
    });

    function animatePitch(tx, ty, callback) {
        let frame = 0;
        const startX = 400, startY = 340;
        const anim = () => {
            frame++;
            drawField();
            let p = frame / 20;
            game.ball.x = startX + (tx - startX) * p;
            game.ball.y = startY + (ty - startY) * p;
            game.ball.active = true;
            
            ctx.beginPath(); ctx.arc(game.ball.x, game.ball.y, 4+p*10, 0, Math.PI*2);
            ctx.fillStyle = "#fff"; ctx.fill();

            if (frame < 20) requestAnimationFrame(anim);
            else {
                game.ball.active = false;
                game.isAnimating = false;
                callback(tx, ty);
            }
        };
        anim();
    }

    // 防守邏輯 (你投，電腦打)
    function resolveDefense(tx, ty) {
        let inZone = tx > 350 && tx < 450 && ty > 430 && ty < 500;
        if (inZone) {
            if (Math.random() < 0.25) { // 電腦安打率
                addLog("!! 電腦擊出安打 !!");
                advanceBases(false);
                resetCount();
            } else {
                game.strikes++;
                addLog("好球！");
                if (game.strikes >= 3) { game.outs++; addLog("三振電腦！"); resetCount(); }
            }
        } else {
            game.balls++;
            addLog("壞球。");
            if (game.balls >= 4) { advanceBases(false); resetCount(); addLog("保送。"); }
        }
        checkSwap();
        updateUI();
    }

    // 進攻邏輯 (電腦投，你打)
    function resolveOffense(isHit, dist) {
        game.ball.active = false;
        if (isHit) {
            game.isAnimating = false;
            if (dist < 10) { addLog("!!! 全壘打 !!!"); scorePoints(true); } 
            else { addLog("你擊出安打！"); advanceBases(true); }
            resetCount();
        }
        updateUI();
    }

    function advanceBases(isPlayer) {
        if (game.bases[2]) { scorePoints(isPlayer); game.bases[2] = false; }
        if (game.bases[1]) { game.bases[2] = true; game.bases[1] = false; }
        if (game.bases[0]) { game.bases[1] = true; game.bases[0] = false; }
        game.bases[0] = true;
        updateUI();
    }

    function scorePoints(isPlayer) {
        if (isPlayer) game.scoreMy++; else game.scoreAi++;
        addLog(isPlayer ? "你得到 1 分！" : "電腦得到 1 分！");
    }

    function checkSwap() {
        if (game.outs >= 3) {
            game.outs = 0; resetCount();
            game.bases = [false, false, false];
            game.isTop = !game.isTop;
            if (game.isTop) game.inning++;
            
            showMsg("攻守交換");
            if (!game.isTop) setTimeout(aiPitchLoop, 2000);
        }
    }

    function aiPitchLoop() {
        if (game.isTop || game.isAnimating) return;
        addLog("電腦投球中...");
        animatePitch(380 + Math.random()*40, 460 + Math.random()*40, (x, y) => {
            if (!game.isTop) {
                game.strikes++; addLog("你沒揮棒，好球！");
                if (game.strikes >= 3) { game.outs++; resetCount(); }
                checkSwap(); updateUI();
                setTimeout(aiPitchLoop, 1500);
            }
        });
    }

    function resetCount() { game.strikes = 0; game.balls = 0; }

    function updateUI() {
        document.getElementById('my-score').innerText = game.scoreMy;
        document.getElementById('ai-score').innerText = game.scoreAi;
        document.getElementById('inning-display').innerText = `${game.inning} 局 ${game.isTop ? '上 (防守)' : '下 (進攻)'}`;
        
        document.getElementById('s1').className = game.strikes >= 1 ? 'on' : '';
        document.getElementById('s2').className = game.strikes >= 2 ? 'on' : '';
        document.getElementById('b1').className = game.balls >= 1 ? 'on' : '';
        document.getElementById('b2').className = game.balls >= 2 ? 'on' : '';
        document.getElementById('b3').className = game.balls >= 3 ? 'on' : '';
        document.getElementById('o1').className = game.outs >= 1 ? 'out-on' : '';
        document.getElementById('o2').className = game.outs >= 2 ? 'out-on' : '';

        let bStr = ""; game.bases.forEach(b => bStr += b ? "◆ " : "◇ ");
        document.getElementById('base-map').innerText = bStr;
    }

    function showMsg(txt) {
        const m = document.getElementById('msg');
        m.innerText = txt; m.style.display = 'block';
        setTimeout(() => m.style.display = 'none', 1500);
    }

    function addLog(m) {
        const l = document.getElementById('log');
        l.innerHTML = `<div>> ${m}</div>` + l.innerHTML;
    }

    drawField();
    updateUI();
</script>
</body>
</html>
